<!DOCTYPE html>
<head>
  <!-- Spotify CSS files -->
  <link rel="stylesheet" type="text/css" href="sp://resources/css/eve.css">
  <link rel="stylesheet" type="text/css" href="sp://resources/css/api.css">
  <link rel="stylesheet" type="text/css" href="sp://resources/css/player.css">
  <link rel="stylesheet" type="text/css" href="sp://resources/css/list.css">

  <!-- Project CSS files -->
  <style>
    /* Main Elements */
    html {-webkit-user-select: auto;}
    body {min-height: 100%;padding: 10px 0 20px;box-sizing: border-box;}
    #wrapper {position: relative;z-index: 2;max-width: 900px;min-height: 100%;margin: 0 auto;padding: 20px;}
    section {position: relative;overflow: hidden;margin: 0 0 40px;}
    .breadcrumb, .gist {margin: 0 0 20px;}
    .right {float:right;}
    h3 + div {margin: 0 0 35px;}


    /* Headers */
    #index h1 {background-image:url('/img/spotify-apps-tutorial.png');background-repeat: no-repeat;width:600px;height:83px;text-indent:-9999em;}


    /* Text */
    h1 {font-size:2em;}
    .description {font-size:1.5em;font-style:italic;font-family:Georgia;padding:0 0 25px;line-height:25px;}


    /* Player */
    #player {min-height:140px; float:right;}
    #player .sp-player {float:left;width:250px;height:250px;}
    #player .sp-list {width:inherit;max-height:inherit;}

    /* Drop Box */
    #drop_box {float:left;width:600px;border:4px dashed #333;height:222px;padding:10px;}
    #drop_box.over {opacity:0.8;border-color:#74c043;}

    /* Index */
    #index h1, #index ul {margin:0 0 30px;}
    #index a:hover {color:#83be20;}

    .clearfix {clear:both;}
  </style>    
  <link rel="stylesheet" type="text/css" href="css/github.css">
</head>
<body>
  <div id="wrapper">
    <div id="index" class="section">
      <h2>Rock Tumbler</h2>
      <div id="drop_box" class=""></div>
      <div id="player"></div>
      <div class="clearfix"></div>
      <hr>
      <div id="original-tracks-list"></div>
      <hr>
      <div id="played-tracks-list"></div>
      <hr>
      <input type="button" id="detonate-this" value="Detonate This Playlist">
      <input type="button" id="detonate-all" value="Detonate All Playlists">
      <script src="/js/lodash.min.js"></script>
      <script src="/js/log.js"></script>
      <script id="worker" type="javascript/worker">
        var msg;
        self.onmessage = function(event) {
          if (event.data.curcontext && event.data.contextclear && event.data.curtrack && event.data.playstate) {
            msg = "initial";
          } else if (!event.data.curcontext && !event.data.contextclear && !event.data.curtrack && event.data.playstate) {
            msg = "play/pause";
          } else if (event.data.curcontext && !event.data.contextclear && event.data.curtrack && event.data.playstate) {
            msg = "ended";
          } else if (!event.data.curcontext && !event.data.contextclear && event.data.curtrack && event.data.playstate) {
            msg = "next";
          } else if (!event.data.curcontext && !event.data.contextclear && !event.data.curtrack && !event.data.playstate) {
            msg = "previous";
          } else if (!event.data.curcontext && event.data.contextclear && event.data.curtrack && event.data.playstate) {
            msg = "jumped";
          } else if (event.data.shuffle) {
            msg = "shuffle";
          }
          self.postMessage(msg);
        }
      </script>
      <script>
        function RandomizerArray(length) {
          this.length = length;
          this.result = _.shuffle(_.range(this.length));
          return true;
        }

        function NextHandler(timeout) {
          var _this = this,count,to_remove,eventTimeoutId;

          this.indexCounter = 0;
          this.timeoutThreshold = timeout;

          this.next = function(rt) {
            _this.indexCounter++;
            clearTimeout(eventTimeoutId);
            eventTimeoutId = setTimeout(function() { onTimeout(rt) }, _this.timeoutThreshold);
          }

          function onTimeout(rt) {
            count = _this.indexCounter;
            _this.indexCounter = 0;
            to_remove = rt.track_array.splice(0,count);
            _.each(to_remove, function(track){rt.expireTrack(track);});
          }

          this.end = function(rt) {
            rt.playlist.remove(_.first(rt.track_array));
            localStorage.removeItem(rt.orig_playlist.data.uri);
            delete rt;
          }
        }

        function RockTumbler() {
          var _this = this,i,t;

          var sp = getSpotifyApi();
          var models = sp.require('$api/models');

          this.player = models.player;
          this.player.shuffle = false;
          this.current_track = this.start_track = null;

          this.init = function(orig_playlist) {
            _this.orig_playlist = orig_playlist;
            _this.playlist = new models.Playlist();
            _this.played_list = new models.Playlist();
            _this.track_array = [];
            _this.played_tracks_array = [];
            _this.local_storage = getLocalStorage();
            _this.r = new RandomizerArray(_this.orig_playlist.length);
            return true;
          }

          this.setupPlaylists = function() {
            var track_uri;
            if (_this.local_storage.length==_this.orig_playlist.length) {
              localStorage.removeItem(_this.orig_playlist.data.uri);
              _this.local_storage = getLocalStorage();
            }

            _(_this.r.result).each(function(value){
              track_uri = _this.orig_playlist.get(value).data.uri;
              if (_.contains(_this.local_storage,track_uri.replace("spotify:track:","")) && !_.contains(_this.played_tracks_array,track_uri)) {
                _this.played_list.add(models.Track.fromURI(track_uri));
                _this.played_tracks_array.push(track_uri);
              } else {
                if (!_.contains(_this.track_array,track_uri)) {
                  _this.playlist.add(models.Track.fromURI(track_uri));
                  _this.track_array.push(track_uri);
                }
              }
            });

            _this.start_track = _this.playlist.get(0);
            return true;
          }

          this.expireTrack = function(track) {
            _this.local_storage.push(track.replace("spotify:track:",""));
            localStorage[_this.orig_playlist.data.uri] = _this.local_storage;
            _this.playlist.remove(track);
            _this.played_list.add(track);
            _this.played_tracks_array.push(track);
            if (_this.player.track) _this.current_track = _this.player.track;
            return true;
          }

          this.moveCurrentTrackToHead = function() {
            i = _this.playlist.indexOf(_this.player.track.data.uri);
            t = _this.track_array.splice(i,1);
            _this.track_array.unshift(_.first(t));
            _this.playlist.data.move(_this.player.track.data.uri,0);
            _this.current_track = _this.playlist.get(0);
            _this.expireTrack(_this.playlist.get(1).uri);
            _this.track_array.splice(1,1);
            return true;
          }

          function getLocalStorage() {
            if (localStorage[_this.orig_playlist.name] && (!localStorage[_this.orig_playlist.data.uri] || localStorage[_this.orig_playlist.data.uri].split(",").length == 0)) { 
              localStorage[_this.orig_playlist.data.uri] = localStorage[_this.orig_playlist.name];
              localStorage.removeItem(rt.orig_playlist.name);
            }
            return localStorage[_this.orig_playlist.data.uri] && localStorage[_this.orig_playlist.data.uri].split(",").length > 0 ? localStorage[_this.orig_playlist.data.uri].split(",") : [];
          }

          this.respond = function(e) {
            switch (e.data) {
              case "initial":
                if (_this.playlist.indexOf(_this.player.track) != 0) {
                _this.moveCurrentTrackToHead();
              } else {
                _this.current_track = _this.start_track;
              }
              break;
              case "next":
                nh.next(_this);
              break;
              case "ended":
                nh.end(_this);
              break;
              case "jumped":
                if (_this.playlist.indexOf(_this.player.track) != 0) {
                _this.moveCurrentTrackToHead();
              }
              case "shuffle":
                _this.player.shuffle = false;
              break;
            }          
          }
        }

        function RockTumblerUI() {
          var _this = this,i;

          var sp = getSpotifyApi();
          var views = sp.require("$api/views");

          this.playlist_HTML = document.getElementById('original-tracks-list');
          this.played_list_HTML = document.getElementById('played-tracks-list');
          this.player_HTML = document.getElementById('player');

          this.init = function(rt) {
            _this.session = rt;
            _this.playlist = new views.List(_this.session.playlist);
            _this.played_list = new views.List(_this.session.played_list);
            _this.playlist.track = _this.played_list.track = null;
            _this.player = new views.Player();
            _this.setContext();
            return true;
          }

          this.placeHTML = function() {
            _this.playlist_HTML.innerHTML = _this.played_list_HTML.innerHTML = _this.player_HTML.innerHTML = '';
            _this.playlist_HTML.appendChild(_this.playlist.node);
            _this.played_list_HTML.appendChild(_this.played_list.node);
            _this.player_HTML.appendChild(_this.player.node);
            return true;
          }

          this.setContext = function() {
            _this.player.context = _this.playlist.context = _this.session.playlist;
            _this.played_list.context = _this.session.played_list;
            return true;
          }
        }

        function RockTumblerObservers(rt,rtUI,models) {
          rt.orig_playlist.observe(models.EVENT.ITEMS_REMOVED, function(event) {
            var in_playlist,i;
            _.each(diffBetweenPlaylists(rt.playlist,rt.orig_playlist,rt.played_list),function(track){   
              rt.playlist.remove(track);
              i = _.indexOf(rt.track_array,track,true);
              rt.track_array.splice(i,1);             
            });
            _.each(diffBetweenPlaylists(rt.played_list,rt.orig_playlist,rt.playlist),function(track){
              rt.played_list.remove(track);
              i = _.indexOf(rt.played_tracks_array,track,true);
              rt.played_tracks_array.splice(i,1);
            });
          });

          rt.orig_playlist.observe(models.EVENT.ITEMS_ADDED, function(event) {
            _.each(diffBetweenPlaylists(rt.orig_playlist,rt.playlist,rt.played_list),function(track){
              rt.playlist.add(track);
              rt.track_array.push(track);
            });
          });

          rt.playlist.observe(models.EVENT.CHANGE, function(event) {
          });

          rt.played_list.observe(models.EVENT.CHANGE, function(event) {
          });

          rt.player.observe(models.EVENT.CHANGE, function(event) {
            log(event);
            worker.postMessage(_(event.data).pairs().object().value());
          });
          return true;
        }

        var sp = getSpotifyApi();
        var models = sp.require('$api/models');
        var views = sp.require("$api/views");

        var rt = new RockTumbler();

        function diffBetweenPlaylists(main,comp1,comp2) {
          main = _.map(main.tracks,function(track){return track.data.uri});
          comp1 = _.map(comp1.tracks,function(track){return track.data.uri}) || [];
          comp2 = _.map(comp2.tracks,function(track){return track.data.uri}) || [];
          return _.difference(main,comp1,comp2);
        }

        function setupDroppedPlaylist(drop) {
          if (!typeof(rt)==='undefined') return false;

          rt.init(models.Playlist.fromURI(drop.uri));
          rt.setupPlaylists();

          rtUI = new RockTumblerUI();
          rtUI.init(rt);
          rtUI.placeHTML();
          RockTumblerObservers(rt,rtUI,models);
          nh = new NextHandler(500);
        }

        // Handle drops
        var drop_box = document.querySelector('#drop_box');

        drop_box.addEventListener('dragstart', function(e){
          e.dataTransfer.setData('text/html', this.innerHTML);
          e.dataTransfer.effectAllowed = 'copy';
        }, false);

        drop_box.addEventListener('dragenter', function(e){
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
          this.classList.add('over');
        }, false);

        drop_box.addEventListener('dragover', function(e){
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
          return false;
        }, false);

        drop_box.addEventListener('dragleave', function(e){
          e.preventDefault();
          this.classList.remove('over');
        }, false);

        drop_box.addEventListener('drop', function(e){
          e.preventDefault();
          player.shuffle = false;
          var drop = models.Playlist.fromURI(e.dataTransfer.getData('text'));
          this.classList.remove('over');
          var success_message = document.createElement('p');
          success_message.innerHTML = 'Playlist: ' + drop.name;
          this.appendChild(success_message);
          setupDroppedPlaylist(drop);
        }, false);

        var blob = new Blob([document.querySelector('#worker').textContent]);

        var worker = new Worker(window.URL.createObjectURL(blob));
        worker.onmessage = function(e) {
          rt.respond(e);
        }

        var detonateThisButton = document.getElementById('detonate-this');
        detonateThisButton.addEventListener('click', detonateThis);

        var detonateAllButton = document.getElementById('detonate-this');
        detonateAllButton.addEventListener('click', detonateAll);

        function detonateThis() {
          localStorage.removeItem(rt.orig_playlist.data.uri);
        }
        function detonateAll() {
          localStorage.clear();
        }
      </script>
    </div>
  </div>
</body>
        </html>
